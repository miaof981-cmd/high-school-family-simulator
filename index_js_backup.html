<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>é«˜ä¸­å®¶æ ¡ç”Ÿæ´»æ¨¡æ‹Ÿå™¨ v2</title>
<style>
  /* ============= B. UI è§„èŒƒï¼ˆå¼ºåˆ¶ï¼‰ ============= */
  .phone{position:relative;width:390px;height:780px;margin:24px auto;background:#fff;
         border:2px solid #D8DCE1;border-radius:24px;overflow:hidden}
  .phone .main{position:absolute;left:0;right:0;top:52px;bottom:64px;overflow:hidden}
  .phone nav{position:absolute;left:0;right:0;bottom:0;height:64px;background:#fff;border-top:1px solid #ECEFF3}

  /* é¡¶éƒ¨æ¡ */
  .topbar{position:absolute;left:0;right:0;top:0;height:52px;display:flex;align-items:center;justify-content:center;
          background:#FFFFFF;border-bottom:1px solid #ECEFF3;font:14px/1.2 system-ui;color:#4B5563}

  /* å¯¼èˆªæ  */
  .nav{display:flex;height:100%}
  .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;font:11px/1.2 system-ui;color:#6B7280;cursor:pointer;transition:color 0.2s}
  .nav-item.active{color:#3B82F6}
  .nav-item .icon{font-size:18px;margin-bottom:2px}

  /* é¡µé¢å®¹å™¨ */
  .page{position:absolute;left:0;right:0;top:0;bottom:0;display:none;overflow:hidden}
  .page.active{display:block}

  /* èŠå¤©é¡µ - å¾®ä¿¡é£æ ¼ */
  .chat-area{position:absolute;left:0;right:0;top:0;bottom:60px;overflow:auto;background:#F7F8FA;z-index:1}
  .chat-list{padding:12px 12px calc(72px + env(safe-area-inset-bottom));}
  .chat-input{position:fixed;left:0;right:0;bottom:0;height:60px;display:flex;gap:8px;padding:10px;background:#fff;border-top:1px solid #eef0f3;z-index:10;padding-bottom:env(safe-area-inset-bottom)}
  
  /* æ¶ˆæ¯æ°”æ³¡ - å¾®ä¿¡é£æ ¼ */
  .msg{position:relative;margin:8px 0;display:flex;}
  .msg .bubble{position:relative;max-width:72%;padding:12px 44px 18px 14px;border-radius:14px;line-height:1.4;background:#fff;color:#1f2329;box-shadow:0 1px 2px rgba(0,0,0,.04);}
  .msg.me{justify-content:flex-end;}
  .msg.me .bubble{background:#a7f3d0;padding:12px 14px 18px 44px;}
  
  /* å¼•ç”¨å— - å¾®ä¿¡é£æ ¼ */
  .bubble .quote{display:flex;gap:8px;align-items:flex-start;padding:8px;margin-bottom:6px;border-radius:8px;background:#f5f6f7;}
  .bubble .quote::before{content:"";width:3px;height:100%;background:#38bdf8;border-radius:2px;}
  .bubble .q-tag{display:inline-block;font-size:12px;color:#64748b;background:#e2e8f0;padding:0 6px;border-radius:6px;flex:0 0 auto;}
  .bubble .q-body{font-size:13px;color:#475569;white-space:pre-wrap;}
  
  /* æ­£æ–‡ */
  .bubble .text{white-space:pre-wrap;word-break:break-word;}
  
  /* æ—¶é—´ä¸å›æ‰§ä¸é‡å  */
  .msg .time{position:absolute;bottom:6px;font-size:11px;color:#8A8F99;}
  .msg.other .time{left:10px;}
  .msg.me .time{right:10px;}
  .msg.me .ack{position:absolute;right:10px;bottom:20px;font-size:11px;color:#8A8F99;}
  
  .msg.system{margin:6px auto;background:#F3F5F9;color:#6B7280;font-size:12px;padding:8px 12px;border-radius:8px;max-width:80%;}

  /* é€‰é¡¹æ ·å¼ */
  .choices{position:fixed;left:0;right:0;bottom:60px;background:#fff;border-top:1px solid #eef0f3;padding:10px;display:none;z-index:100;padding-bottom:env(safe-area-inset-bottom)}
  .choices.show{display:block}
  .choice{display:block;width:100%;padding:12px;margin:4px 0;border:1px solid #E5E7EB;border-radius:8px;background:#fff;font:14px/1.4 system-ui;color:#374151;cursor:pointer;text-align:left}
  .choice:hover{background:#F9FAFB}
  .choice:active{transform:translateY(1px)}

  /* çŠ¶æ€é¡µ */
  .status-content{padding:16px;overflow:auto;height:100%}
  .status-section{margin-bottom:20px;padding:12px;background:#F9FAFB;border-radius:8px}
  .status-title{font:16px/1.4 system-ui;color:#111827;margin-bottom:8px;font-weight:600}
  .status-item{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #E5E7EB}
  .status-item:last-child{border-bottom:none}
  .status-label{font:14px/1.4 system-ui;color:#6B7280}
  .status-value{font:14px/1.4 system-ui;color:#111827;font-weight:500}
  .progress-bar{width:100px;height:6px;background:#E5E7EB;border-radius:3px;overflow:hidden}
  .progress-fill{height:100%;background:#3B82F6;transition:width 0.3s}

  /* æ“ä½œé¡µ */
  .actions-content{padding:16px;overflow:auto;height:100%}
  .action-btn{display:block;width:100%;padding:16px;margin:8px 0;border:1px solid #D1D5DB;border-radius:10px;background:#fff;font:14px/1.4 system-ui;color:#374151;cursor:pointer;text-align:left}
  .action-btn:hover{background:#F9FAFB}
  .action-btn:active{transform:translateY(1px)}

  /* å¼¹çª— */
  .modal{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:1100}
  .modal.show{display:flex}
  .modal-content{background:#fff;border-radius:12px;padding:20px;margin:20px;max-width:320px;width:100%}
  .modal-title{font:18px/1.4 system-ui;color:#111827;margin-bottom:16px;font-weight:600}
  .modal-input{width:100%;padding:10px;border:1px solid #D1D5DB;border-radius:8px;font:14px system-ui;margin-bottom:12px}
  .modal-buttons{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
  .btn{display:inline-flex;align-items:center;justify-content:center;border:1px solid #D1D5DB;border-radius:8px;height:36px;padding:0 16px;font:14px system-ui;color:#374151;background:#fff;cursor:pointer}
  .btn.primary{background:#3B82F6;color:#fff;border-color:#3B82F6}
  .btn:active{transform:translateY(1px)}

  /* æ—¶é—´æ®µæŒ‡ç¤ºå™¨ */
  .time-indicator{position:absolute;left:0;right:0;top:0;height:52px;display:flex;align-items:center;justify-content:center;font:12px/1.2 system-ui;color:#6B7280;background:#F9FAFB;border-bottom:1px solid #E5E7EB}
  .time-indicator.quiet{color:#EF4444}
  .time-indicator.chat{color:#10B981}

  /* ç¾¤èŠé¡µ */
  .group-content{padding:16px;overflow:auto;height:100%}
  .group-msg{max-width:85%;margin:8px 0;padding:10px 12px;border-radius:14px;line-height:1.4;background:#EEF1F6;word-break:break-word}
  .group-msg.teacher{background:#E0F2FE;border-left:3px solid #0EA5E9}
  .group-msg.parent{background:#F3E8FF;border-left:3px solid #8B5CF6}
  .group-msg.self{background:#DCF8C6;margin-left:auto;text-align:right}
  .group-time{font-size:11px;color:#8A8F99;margin-top:4px}

  /* MBTIå¡ç‰‡ */
  .mbti-card{padding:12px;background:#F9FAFB;border-radius:8px;margin-bottom:20px}
  .mbti-title{font:16px/1.4 system-ui;color:#111827;margin-bottom:8px;font-weight:600}
  .mbti-code{font:24px/1.2 system-ui;color:#3B82F6;font-weight:bold;text-align:center;margin:8px 0}
  .mbti-trait{display:flex;justify-content:space-between;align-items:center;padding:4px 0}
  .mbti-bar{width:100px;height:6px;background:#E5E7EB;border-radius:3px;overflow:hidden}
  .mbti-fill{height:100%;background:#3B82F6;transition:width 0.3s}
  
  /* Toasté€šçŸ¥ */
  .toast{position:fixed;right:16px;bottom:80px;background:#1f2937;color:#fff;padding:8px 16px;border-radius:8px;font:14px/1.4 system-ui;z-index:900;opacity:0;transform:translateY(20px);transition:all 0.3s}
  .toast.show{opacity:1;transform:translateY(0)}
  
  /* å±‚çº§ç»Ÿä¸€ */
  .modal{z-index:1100}
  .attribute-feedback,.notification,.toast{z-index:900}
  .choices{z-index:100}
  .chat-area{z-index:1}
  
  /* è½¯é”®ç›˜å¤„ç† */
  body.modal-open{overflow:hidden}
</style>
</head>
<body>

<div class="phone">
  <!-- æ—¶é—´æ®µæŒ‡ç¤ºå™¨ -->
  <div id="timeIndicator" class="time-indicator">
    <span id="timeText">ä¸Šè¯¾ä¸­</span>
  </div>

  <!-- ä¸»å†…å®¹åŒº -->
  <div class="main">
    <!-- å®¶é•¿ç¾¤é¡µé¢ -->
    <div id="groupPage" class="page active">
      <div class="group-content">
        <div class="group-msg teacher">
          <div>å„ä½å®¶é•¿å¥½ï¼Œä»Šå¤©æ•°å­¦å°æµ‹æˆç»©å·²å…¬å¸ƒï¼Œè¯·å…³æ³¨å­©å­å­¦ä¹ çŠ¶æ€ã€‚</div>
          <div class="group-time">14:30</div>
        </div>
        <div class="group-msg parent">
          <div>è°¢è°¢è€å¸ˆæé†’ï¼Œæˆ‘ä»¬ä¼šç£ä¿ƒå­©å­è®¤çœŸå¤ä¹ çš„ã€‚</div>
          <div class="group-time">14:32</div>
        </div>
        <div class="group-msg self">
          <div>æ”¶åˆ°ï¼Œæˆ‘ä»¬ä¼šé…åˆè€å¸ˆçš„å·¥ä½œã€‚</div>
          <div class="group-time">14:35</div>
        </div>
      </div>
      <div class="chat-input">
        <button id="showGroupChoices" class="btn">é€‰æ‹©æ¶ˆæ¯</button>
        <input id="groupMessageInput" class="input" type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." style="flex:1;border:1px solid #E5E7EB;border-radius:10px;height:38px;padding:0 10px;font:14px system-ui;color:#111827;background:#fff" />
        <button id="sendGroupMessage" class="btn">å‘é€</button>
      </div>
    </div>

    <!-- è”ç³»å­©å­é¡µé¢ -->
    <div id="contactPage" class="page">
      <div id="chat" class="chat-area">
        <ul id="chatList" class="chat-list"></ul>
      </div>
      <div class="chat-input">
        <input id="messageInput" class="input" type="text" placeholder="ç‚¹å‡»é€‰æ‹©æ¶ˆæ¯..." readonly style="flex:1;border:1px solid #E5E7EB;border-radius:10px;height:38px;padding:0 10px;font:14px system-ui;color:#111827;background:#fff" />
        <button id="sendMessage" class="btn" disabled>å‘é€</button>
      </div>
      <div id="choices" class="choices">
        <!-- åŠ¨æ€ç”Ÿæˆé€‰é¡¹ -->
      </div>
    </div>

    <!-- å®¶é•¿æ“ä½œé¡µé¢ -->
    <div id="actionsPage" class="page">
      <div class="actions-content">
        <button class="action-btn" onclick="openModal('mailModal')">ğŸ“¦ é‚®å¯„ç‰©å“</button>
        <button class="action-btn" onclick="openModal('campusCardModal')">ğŸ’³ æ ¡å›­å¡å……å€¼</button>
        <button class="action-btn" onclick="openModal('phoneCardModal')">ğŸ“± ç”µè¯å¡å……å€¼</button>
        <button class="action-btn" onclick="openModal('suggestionModal')">ğŸ’¡ æä¾›å»ºè®®</button>
      </div>
    </div>

    <!-- å­©å­çŠ¶æ€é¡µé¢ -->
    <div id="statusPage" class="page">
      <div class="status-content">
        <!-- MBTIå¡ç‰‡ -->
        <div class="mbti-card">
          <div class="mbti-title">ğŸ§  MBTI æ€§æ ¼åˆ†æ</div>
          <div class="mbti-code" id="mbtiCode">INFP</div>
          <div class="mbti-trait">
            <span>å¤–å‘(E) - å†…å‘(I)</span>
            <div class="mbti-bar"><div class="mbti-fill" id="eiBar" style="width:12%"></div></div>
            <span id="eiValue">12%</span>
          </div>
          <div class="mbti-trait">
            <span>æ„Ÿè§‰(S) - ç›´è§‰(N)</span>
            <div class="mbti-bar"><div class="mbti-fill" id="snBar" style="width:35%"></div></div>
            <span id="snValue">35%</span>
          </div>
          <div class="mbti-trait">
            <span>æ€è€ƒ(T) - æƒ…æ„Ÿ(F)</span>
            <div class="mbti-bar"><div class="mbti-fill" id="tfBar" style="width:40%"></div></div>
            <span id="tfValue">40%</span>
          </div>
          <div class="mbti-trait">
            <span>åˆ¤æ–­(J) - æ„ŸçŸ¥(P)</span>
            <div class="mbti-bar"><div class="mbti-fill" id="jpBar" style="width:28%"></div></div>
            <span id="jpValue">28%</span>
          </div>
        </div>
        
        <div class="status-section">
          <div class="status-title">ğŸ’° èµ„é‡‘çŠ¶å†µ</div>
          <div class="status-item">
            <span class="status-label">å®¶é•¿èµ„é‡‘</span>
            <span class="status-value" id="parentMoney">Â¥2000</span>
          </div>
          <div class="status-item">
            <span class="status-label">æ ¡å›­å¡ä½™é¢</span>
            <span class="status-value" id="campusMoney">Â¥120</span>
          </div>
          <div class="status-item">
            <span class="status-label">ç”µè¯å¡ä½™é¢</span>
            <span class="status-value" id="phoneMoney">Â¥20</span>
          </div>
        </div>

        <div class="status-section">
          <div class="status-title">â¤ï¸ å…³ç³»çŠ¶æ€</div>
          <div class="status-item">
            <span class="status-label">å¥½æ„Ÿåº¦</span>
            <div style="display:flex;align-items:center;gap:8px">
              <div class="progress-bar"><div class="progress-fill" id="favorBar" style="width:50%"></div></div>
              <span class="status-value" id="favorValue">50</span>
            </div>
          </div>
          <div class="status-item">
            <span class="status-label">ä¿¡ä»»åº¦</span>
            <div style="display:flex;align-items:center;gap:8px">
              <div class="progress-bar"><div class="progress-fill" id="trustBar" style="width:50%"></div></div>
              <span class="status-value" id="trustValue">50</span>
            </div>
          </div>
        </div>

        <div class="status-section">
          <div class="status-title">ğŸ“Š äº”ç»´å±æ€§</div>
          <div class="status-item">
            <span class="status-label">å­¦ä¹ </span>
            <div style="display:flex;align-items:center;gap:8px">
              <div class="progress-bar"><div class="progress-fill" id="studyBar" style="width:62%"></div></div>
              <span class="status-value" id="studyValue">62</span>
            </div>
          </div>
          <div class="status-item">
            <span class="status-label">å‹¤å¥‹</span>
            <div style="display:flex;align-items:center;gap:8px">
              <div class="progress-bar"><div class="progress-fill" id="diligentBar" style="width:58%"></div></div>
              <span class="status-value" id="diligentValue">58</span>
            </div>
          </div>
          <div class="status-item">
            <span class="status-label">ç¤¾äº¤</span>
            <div style="display:flex;align-items:center;gap:8px">
              <div class="progress-bar"><div class="progress-fill" id="socialBar" style="width:40%"></div></div>
              <span class="status-value" id="socialValue">40</span>
            </div>
          </div>
          <div class="status-item">
            <span class="status-label">ç‹¬ç«‹</span>
            <div style="display:flex;align-items:center;gap:8px">
              <div class="progress-bar"><div class="progress-fill" id="independentBar" style="width:70%"></div></div>
              <span class="status-value" id="independentValue">70</span>
            </div>
          </div>
          <div class="status-item">
            <span class="status-label">æ­£ä¹‰</span>
            <div style="display:flex;align-items:center;gap:8px">
              <div class="progress-bar"><div class="progress-fill" id="justiceBar" style="width:0%"></div></div>
              <span class="status-value" id="justiceValue">0</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å¯¼èˆªæ  -->
  <nav class="nav">
    <div class="nav-item active" onclick="switchTab('group')">
      <div class="icon">ğŸ‘¥</div>
      <div>å®¶é•¿ç¾¤</div>
    </div>
    <div class="nav-item" onclick="switchTab('contact')">
      <div class="icon">ğŸ’¬</div>
      <div>è”ç³»å­©å­</div>
    </div>
    <div class="nav-item" onclick="switchTab('actions')">
      <div class="icon">âš™ï¸</div>
      <div>å®¶é•¿æ“ä½œ</div>
    </div>
    <div class="nav-item" onclick="switchTab('status')">
      <div class="icon">ğŸ“Š</div>
      <div>å­©å­çŠ¶æ€</div>
    </div>
  </nav>

  <!-- Toasté€šçŸ¥ -->
  <div id="toast" class="toast"></div>

  <!-- å¼¹çª— -->
  <div id="mailModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">é‚®å¯„ç‰©å“</div>
      <select class="modal-input" id="mailType">
        <option value="snacks">é›¶é£Ÿ</option>
        <option value="clothes">è¡£ç‰©</option>
        <option value="books">ä¹¦ç±</option>
        <option value="medicine">è¯å“</option>
      </select>
      <input class="modal-input" type="text" placeholder="å¤‡æ³¨ä¿¡æ¯" id="mailNote" />
      <div class="modal-buttons">
        <button class="btn" onclick="closeModal('mailModal')">å–æ¶ˆ</button>
        <button class="btn primary" onclick="sendMail()">é‚®å¯„</button>
      </div>
    </div>
  </div>

  <div id="campusCardModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">æ ¡å›­å¡å……å€¼</div>
      <input class="modal-input" type="number" placeholder="å……å€¼é‡‘é¢" id="campusAmount" />
      <div class="modal-buttons">
        <button class="btn" onclick="closeModal('campusCardModal')">å–æ¶ˆ</button>
        <button class="btn primary" onclick="rechargeCampusCard()">å……å€¼</button>
      </div>
    </div>
  </div>

  <div id="phoneCardModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">ç”µè¯å¡å……å€¼</div>
      <input class="modal-input" type="number" placeholder="å……å€¼é‡‘é¢" id="phoneAmount" />
      <div class="modal-buttons">
        <button class="btn" onclick="closeModal('phoneCardModal')">å–æ¶ˆ</button>
        <button class="btn primary" onclick="rechargePhoneCard()">å……å€¼</button>
      </div>
    </div>
  </div>

  <div id="suggestionModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">æä¾›å»ºè®®</div>
      <textarea class="modal-input" placeholder="è¾“å…¥å»ºè®®å†…å®¹" id="suggestionText" style="height:80px;resize:none"></textarea>
      <div class="modal-buttons">
        <button class="btn" onclick="closeModal('suggestionModal')">å–æ¶ˆ</button>
        <button class="btn primary" onclick="sendSuggestion()">å‘é€</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ============= C. æ•°æ®æ¨¡å‹ ============= */
const state = {
  slot: 'class', // class | noonBreak | nightStudy | afterNightStudy | night
  testMode: false,

  // èµ„é‡‘
  money: { parent: 2000, campus: 120, tel: 20 },

  // å…³ç³»
  rel: { favor: 50, trust: 50 },

  // å±æ€§ï¼ˆ0-100ï¼‰
  attrs: { study: 62, diligent: 58, social: 40, independent: 70, justice: 0 },

  // ä¼šè¯
  group: [
    {id: 1, from: 'teacher', text: 'å„ä½å®¶é•¿å¥½ï¼Œä»Šå¤©æ•°å­¦å°æµ‹æˆç»©å·²å…¬å¸ƒï¼Œè¯·å…³æ³¨å­©å­å­¦ä¹ çŠ¶æ€ã€‚', ts: Date.now() - 300000},
    {id: 2, from: 'parentOther', text: 'è°¢è°¢è€å¸ˆæé†’ï¼Œæˆ‘ä»¬ä¼šç£ä¿ƒå­©å­è®¤çœŸå¤ä¹ çš„ã€‚', ts: Date.now() - 280000},
    {id: 3, from: 'parentSelf', text: 'æ”¶åˆ°ï¼Œæˆ‘ä»¬ä¼šé…åˆè€å¸ˆçš„å·¥ä½œã€‚', ts: Date.now() - 250000}
  ],
  dm: [
    {id: 1, from: 'child', text: 'ï¼ˆç¤ºä¾‹ï¼‰ä»Šå¤©æ•°å­¦å°æµ‹ï¼Œè¿˜ç®—é¡ºåˆ©ï½', ts: Date.now() - 600000, status: 'read'}
  ],

  // é˜Ÿåˆ—ï¼šå®‰é™æ—¶æ®µå®¶é•¿å‘å‡ºçš„"å·²é€è¾¾æœªè¯»"
  unreadForChild: [],

  // UI
  activeTab: 'group',
  choicesStyle: 'alpha' // 'alpha' or 'numeric'
};

let timers = [];

/* ============= æ—¶é—´æ®µçŠ¶æ€æœº ============= */
function after(ms, fn) { 
  const t = setTimeout(fn, ms); 
  timers.push(t); 
  return t; 
}

function clearAllTimers() { 
  timers.forEach(clearTimeout); 
  timers = []; 
}

function setSlot(next) {
  if (state.slot === next) return;
  clearAllTimers();
  state.slot = next;
  updateTimeIndicator();

  // å®‰é™->å¯èŠï¼šå¼€åœºç™½ + flush æœªè¯»
  if (next === 'noonBreak' || next === 'afterNightStudy') {
    const opening = next === 'noonBreak' ? 'æˆ‘ç°åœ¨åˆä¼‘å•¦ï½' : 'æˆ‘ç°åœ¨ä¸‹æ™šè‡ªä¹ å•¦ï½';
    addDM('child', opening, 'read');
    flushUnreadWithQuotedReplies();
  }
}

async function flushUnreadWithQuotedReplies() {
  const ids = [...state.unreadForChild];
  state.unreadForChild = [];
  
  for (let i = 0; i < ids.length; i++) {
    const pid = ids[i];
    markReadUpTo(pid);
    
    // å»¶è¿Ÿå‘é€å›å¤ï¼Œæ¨¡æ‹Ÿé€æ¡å¤„ç†
    await new Promise(resolve => setTimeout(resolve, 600 + i * 800));
    
    const parentMsg = state.dm.find(m => m.id === pid);
    if (parentMsg) {
      const reply = await autoReplyFor(pid);
      addDM('child', `> å¼•ç”¨ï¼š${parentMsg.text}\n${reply}`, {refId: pid});
    }
  }
}

function updateTimeIndicator() {
  const indicator = document.getElementById('timeIndicator');
  const timeText = document.getElementById('timeText');
  const timeMap = {
    'class': 'ä¸Šè¯¾ä¸­',
    'noonBreak': 'åˆä¼‘æ—¶é—´',
    'nightStudy': 'æ™šè‡ªä¹ ',
    'afterNightStudy': 'ä¸‹æ™šè‡ªä¹ ',
    'night': 'å°±å¯æ—¶é—´'
  };
  
  timeText.textContent = timeMap[state.slot] || 'æœªçŸ¥çŠ¶æ€';
  
  if (isQuiet()) {
    indicator.className = 'time-indicator quiet';
  } else {
    indicator.className = 'time-indicator chat';
  }
}

/* ============= ç§èŠåŠŸèƒ½ ============= */
function addDM(from, text, {status = 'delivered', refId = null} = {}) {
  const id = Date.now() + Math.random();
  state.dm.push({ id, from, text, ts: Date.now(), status, refId });
  renderDM();
  return id;
}

function sendParent(text) {
  const id = addDM('parent', text, {status: 'delivered'});
  
  // æ ¹æ®æ¶ˆæ¯å†…å®¹å½±å“æ•°å€¼
  applyMessageEffect(text);
  
  if (isQuiet()) {
    state.unreadForChild.push(id);
    addDM('system', quietTip(state.slot));
  } else {
    after(300, () => markReadUpTo(id));
    after(800, () => addDM('child', autoReplyFor(id), {refId: id}));
  }
}

function applyMessageEffect(text) {
  // æ ¹æ®æ¶ˆæ¯å†…å®¹è°ƒæ•´å±æ€§
  if (text.includes('ä¼‘æ¯') || text.includes('ç¡è§‰')) {
    state.rel.favor += 1;
    state.attrs.diligent += 1;
  } else if (text.includes('å­¦ä¹ ') || text.includes('è€å¸ˆ') || text.includes('å¤ä¹ ')) {
    state.attrs.study += 1;
    state.rel.trust += 1;
  } else if (text.includes('åƒé¥­') || text.includes('è¥å…»')) {
    state.rel.favor += 1;
    state.attrs.social += 1;
  } else if (text.includes('æ³¨æ„å®‰å…¨') || text.includes('å°å¿ƒ')) {
    state.rel.favor += 2;
    state.attrs.justice += 1;
  }
  
  // ç¡®ä¿æ•°å€¼åœ¨0-100èŒƒå›´å†…
  state.rel.favor = Math.max(0, Math.min(100, state.rel.favor));
  state.rel.trust = Math.max(0, Math.min(100, state.rel.trust));
  Object.keys(state.attrs).forEach(key => {
    state.attrs[key] = Math.max(0, Math.min(100, state.attrs[key]));
  });
  
  updateStatusDisplay();
}

function markReadUpTo(id) {
  state.dm.forEach(m => {
    if (m.from === 'parent' && m.id <= id) m.status = 'read';
  });
  renderDM();
}

const isQuiet = () => !['noonBreak', 'afterNightStudy'].includes(state.slot) && !state.testMode;

function quietTip(slot) {
  if (slot === 'class') return 'å­©å­åœ¨ä¸Šè¯¾ï¼Œæš‚æ—¶æ— æ³•å›å¤ã€‚';
  if (slot === 'nightStudy') return 'å­©å­åœ¨æ™šè‡ªä¹ ï¼Œç¨åç»Ÿä¸€å›å¤ã€‚';
  if (slot === 'night') return 'å­©å­å·²å°±å¯ï¼Œæ˜æ—©æ‰èƒ½çœ‹åˆ°æ¶ˆæ¯ã€‚';
  return 'å­©å­æš‚æ—¶æ— æ³•å›å¤ã€‚';
}

async function autoReplyFor(parentId) {
  const parentMsg = state.dm.find(m => m.id === parentId);
  if (!parentMsg) return 'å¥½çš„ï¼Œæˆ‘çŸ¥é“äº†ã€‚';
  
  try {
    // è°ƒç”¨AIæ¥å£ç”Ÿæˆå›å¤
    const response = await fetch('https://dmxapi.cn/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer sk-9ANtPqUHF4aLqKvE2U714fbvpj3Rk4UUEzfSobmUk0C1ZMd4'
      },
      body: JSON.stringify({
        role: 'child',
        context: {
          favor: state.rel.favor,
          trust: state.rel.trust,
          attrs: state.attrs,
          money: state.money,
          lastMessages: [parentMsg.text]
        }
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      return data.reply || 'å¥½çš„ï¼Œæˆ‘çŸ¥é“äº†ã€‚';
    }
  } catch (error) {
    console.log('AIæ¥å£è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å›å¤');
  }
  
  // å…œåº•å›å¤é€»è¾‘ï¼ŒåŸºäºæ•°å€¼ç³»ç»Ÿ
  const replies = generateSmartReply(parentMsg.text);
  return replies[Math.floor(Math.random() * replies.length)];
}

function generateSmartReply(parentText) {
  const { favor, trust } = state.rel;
  const { study, diligent, social, independent, justice } = state.attrs;
  
  // åŸºäºå¥½æ„Ÿåº¦å’Œä¿¡ä»»åº¦çš„å›å¤
  if (favor >= 70) {
    return [
      'å¥½çš„å¦ˆå¦ˆï¼Œæˆ‘ä¼šæ³¨æ„çš„ï½',
      'å—¯å—¯ï¼Œè°¢è°¢å…³å¿ƒï¼',
      'æ”¶åˆ°ï¼Œæˆ‘ä¼šç…§åšçš„ï¼'
    ];
  } else if (favor >= 40) {
    return [
      'å¥½çš„ï¼Œæˆ‘çŸ¥é“äº†ã€‚',
      'å—¯å—¯ï¼Œæˆ‘ä¼šæ³¨æ„çš„ã€‚',
      'æ”¶åˆ°ï¼Œè°¢è°¢å…³å¿ƒã€‚'
    ];
  } else {
    return [
      'çŸ¥é“äº†ã€‚',
      'å—¯ã€‚',
      'å¥½çš„ã€‚'
    ];
  }
}

function renderDM() {
  const wrap = document.getElementById('chat');
  wrap.innerHTML = '';
  
  state.dm.forEach(m => {
    const div = document.createElement('div');
    div.className = 'msg ' + (m.from === 'child' ? 'other' : (m.from === 'parent' ? 'me' : 'system'));
    div.textContent = m.text;
    
    if (m.from !== 'system') {
      const t = document.createElement('div');
      t.className = 'time';
      const d = new Date(m.ts);
      t.textContent = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
      div.appendChild(t);
      
      // å›æ‰§åªæ˜¾ç¤ºåœ¨å®¶é•¿æœ€åä¸€æ¡æ¶ˆæ¯
      if (m.from === 'parent') {
        const isLastParent = state.dm.filter(msg => msg.from === 'parent').pop() === m;
        if (isLastParent) {
          const ack = document.createElement('div');
          ack.className = 'ack';
          ack.textContent = m.status === 'delivered' ? 'å·²é€è¾¾' : 'å·²è¯»';
          div.appendChild(ack);
        }
      }
    }
    
    wrap.appendChild(div);
  });
  
  wrap.scrollTop = wrap.scrollHeight + 999;
}

/* ============= é€‰é¡¹åŠŸèƒ½ ============= */
function showChoices() {
  generateChoices();
  const choices = document.getElementById('choices');
  choices.classList.add('show');
}

function generateChoices() {
  const choicesContainer = document.getElementById('choices');
  const currentSlot = state.slot;
  
  // æ ¹æ®æ—¶é—´æ®µå’Œå½“å‰çŠ¶æ€ç”Ÿæˆä¸åŒçš„é€‰é¡¹
  let options = [];
  
  if (currentSlot === 'class' || currentSlot === 'nightStudy') {
    options = [
      'å¥½å¥½å­¦ä¹ ï¼Œæ³¨æ„ä¼‘æ¯',
      'æœ‰ä¸æ‡‚çš„åŠæ—¶é—®è€å¸ˆ',
      'æ™šè‡ªä¹ åŠ æ²¹ï¼Œæ—©ç‚¹å›å®¿èˆ'
    ];
  } else if (currentSlot === 'noonBreak') {
    options = [
      'åˆä¼‘æ—¶é—´å¥½å¥½ä¼‘æ¯',
      'è®°å¾—æŒ‰æ—¶åƒåˆé¥­',
      'ä¸‹åˆè¯¾ç¨‹åŠ æ²¹'
    ];
  } else if (currentSlot === 'afterNightStudy') {
    options = [
      'æ™šè‡ªä¹ è¾›è‹¦äº†ï¼Œæ—©ç‚¹ä¼‘æ¯',
      'å›å®¿èˆè·¯ä¸Šæ³¨æ„å®‰å…¨',
      'æ˜å¤©ç»§ç»­åŠ æ²¹'
    ];
  } else if (currentSlot === 'night') {
    options = [
      'æ—©ç‚¹ç¡è§‰ï¼Œæ˜å¤©è¿˜è¦ä¸Šè¯¾',
      'æ™šå®‰ï¼Œåšä¸ªå¥½æ¢¦',
      'æ˜å¤©è§ï¼Œå¥½å¥½å­¦ä¹ '
    ];
  } else {
    options = [
      'å¥½å¥½å­¦ä¹ ï¼Œæ³¨æ„èº«ä½“',
      'æœ‰å›°éš¾åŠæ—¶è”ç³»',
      'åŠ æ²¹ï¼Œæˆ‘ä»¬æ”¯æŒä½ '
    ];
  }
  
  // æ¸…ç©ºç°æœ‰é€‰é¡¹
  choicesContainer.innerHTML = '';
  
  // ç”Ÿæˆæ–°é€‰é¡¹
  options.forEach((text, index) => {
    const choice = document.createElement('div');
    choice.className = 'choice';
    choice.dataset.text = text;
    choice.textContent = `${String.fromCharCode(65 + index)}. ${text}`;
    choice.addEventListener('click', () => chooseOption(text));
    choicesContainer.appendChild(choice);
  });
}

function hideChoices() {
  const choices = document.getElementById('choices');
  choices.classList.remove('show');
}

function chooseOption(text) {
  sendParent(text);
  hideChoices();
}

/* ============= æ ‡ç­¾é¡µåˆ‡æ¢ ============= */
function switchTab(tab) {
  // æ›´æ–°å¯¼èˆªçŠ¶æ€
  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
  event.target.closest('.nav-item').classList.add('active');
  
  // æ›´æ–°é¡µé¢æ˜¾ç¤º
  document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
  document.getElementById(tab + 'Page').classList.add('active');
  
  state.activeTab = tab;
}

/* ============= å¼¹çª—åŠŸèƒ½ ============= */
function openModal(modalId) {
  document.getElementById(modalId).classList.add('show');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('show');
}

function sendMail() {
  const type = document.getElementById('mailType').value;
  const note = document.getElementById('mailNote').value;
  addDM('system', `å·²é‚®å¯„${type}${note ? 'ï¼š' + note : ''}ï¼Œé¢„è®¡æ˜å¤©é€è¾¾ã€‚`);
  closeModal('mailModal');
}

function rechargeCampusCard() {
  const amount = parseInt(document.getElementById('campusAmount').value);
  if (amount > 0) {
    state.money.campus += amount;
    state.money.parent -= amount;
    updateStatusDisplay();
    addDM('system', `æ ¡å›­å¡å……å€¼æˆåŠŸï¼Œä½™é¢ï¼šÂ¥${state.money.campus}`);
    closeModal('campusCardModal');
  }
}

function rechargePhoneCard() {
  const amount = parseInt(document.getElementById('phoneAmount').value);
  if (amount > 0) {
    state.money.tel += amount;
    state.money.parent -= amount;
    updateStatusDisplay();
    addDM('system', `ç”µè¯å¡å……å€¼æˆåŠŸï¼Œä½™é¢ï¼šÂ¥${state.money.tel}`);
    closeModal('phoneCardModal');
  }
}

function sendSuggestion() {
  const text = document.getElementById('suggestionText').value;
  if (text.trim()) {
    addDM('system', `å»ºè®®å·²å‘é€ï¼š${text}`);
    closeModal('suggestionModal');
  }
}

/* ============= çŠ¶æ€æ›´æ–° ============= */
function updateStatusDisplay() {
  document.getElementById('parentMoney').textContent = `Â¥${state.money.parent}`;
  document.getElementById('campusMoney').textContent = `Â¥${state.money.campus}`;
  document.getElementById('phoneMoney').textContent = `Â¥${state.money.tel}`;
  
  document.getElementById('favorValue').textContent = state.rel.favor;
  document.getElementById('favorBar').style.width = state.rel.favor + '%';
  document.getElementById('trustValue').textContent = state.rel.trust;
  document.getElementById('trustBar').style.width = state.rel.trust + '%';
  
  document.getElementById('studyValue').textContent = state.attrs.study;
  document.getElementById('studyBar').style.width = state.attrs.study + '%';
  document.getElementById('diligentValue').textContent = state.attrs.diligent;
  document.getElementById('diligentBar').style.width = state.attrs.diligent + '%';
  document.getElementById('socialValue').textContent = state.attrs.social;
  document.getElementById('socialBar').style.width = state.attrs.social + '%';
  document.getElementById('independentValue').textContent = state.attrs.independent;
  document.getElementById('independentBar').style.width = state.attrs.independent + '%';
  document.getElementById('justiceValue').textContent = state.attrs.justice;
  document.getElementById('justiceBar').style.width = state.attrs.justice + '%';
}

/* ============= äº‹ä»¶ç›‘å¬ ============= */
document.addEventListener('DOMContentLoaded', function() {
  // é€‰é¡¹ç‚¹å‡»äº‹ä»¶
  document.querySelectorAll('.choice').forEach(choice => {
    choice.addEventListener('click', () => chooseOption(choice.dataset.text));
  });
  
  // æ˜¾ç¤ºé€‰é¡¹æŒ‰é’®
  document.getElementById('showChoices').addEventListener('click', showChoices);
  
  // å‘é€æ¶ˆæ¯æŒ‰é’®
  document.getElementById('sendMessage').addEventListener('click', () => {
    const input = document.getElementById('messageInput');
    if (input.value.trim()) {
      sendParent(input.value);
      input.value = '';
    }
  });
  
  // å›è½¦å‘é€
  document.getElementById('messageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      const input = document.getElementById('messageInput');
      if (input.value.trim()) {
        sendParent(input.value);
        input.value = '';
      }
    }
  });
  
  // å¼¹çª—é®ç½©ç‚¹å‡»å…³é—­
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('show');
      }
    });
  });
  
  // ESCå…³é—­å¼¹çª—
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll('.modal.show').forEach(modal => {
        modal.classList.remove('show');
      });
    }
  });
  
  // åˆå§‹åŒ–æ˜¾ç¤º
  updateTimeIndicator();
  updateStatusDisplay();
  renderDM();
});

/* ============= æ—¶é—´æ®µæ§åˆ¶ï¼ˆæµ‹è¯•ç”¨ï¼‰ ============= */
function setTimeSlot(slot) {
  setSlot(slot);
}

// æ·»åŠ æ—¶é—´æ®µæ§åˆ¶æŒ‰é’®ï¼ˆä»…æµ‹è¯•ç”¨ï¼‰
document.addEventListener('DOMContentLoaded', function() {
  const timeControls = document.createElement('div');
  timeControls.style.cssText = 'position:fixed;top:10px;right:10px;z-index:2000;display:flex;gap:5px;';
  timeControls.innerHTML = `
    <button onclick="setTimeSlot('class')" style="padding:5px 10px;font-size:12px;">ä¸Šè¯¾</button>
    <button onclick="setTimeSlot('noonBreak')" style="padding:5px 10px;font-size:12px;">åˆä¼‘</button>
    <button onclick="setTimeSlot('nightStudy')" style="padding:5px 10px;font-size:12px;">æ™šè‡ªä¹ </button>
    <button onclick="setTimeSlot('afterNightStudy')" style="padding:5px 10px;font-size:12px;">ä¸‹æ™šè‡ªä¹ </button>
    <button onclick="setTimeSlot('night')" style="padding:5px 10px;font-size:12px;">å°±å¯</button>
  `;
  document.body.appendChild(timeControls);
});
</script>

<!-- ğŸ§ª å†’çƒŸæµ‹è¯•è„šæœ¬ -->
<script>
(function smoke(){
  const host = document.querySelector('.phone');
  const warn = msg=>{
    let box = document.getElementById('smoke'); 
    if(!box){ 
      box=document.createElement('div'); 
      box.id='smoke'; 
      host.appendChild(box);
      Object.assign(box.style,{
        position:'absolute',left:'8px',bottom:'72px',
        background:'#fff5f5',border:'1px solid #ff4d4f',
        padding:'6px 8px',borderRadius:'8px',
        font:'12px/1.4 system-ui',maxWidth:'80%'
      });
    }
    box.textContent = msg;
  };
  if(!host) return;
  const ib = document.querySelector('.chat-input');
  if(!ib || getComputedStyle(ib).position!=='absolute') 
    return warn('âŒ è¾“å…¥æ¡å¿…é¡»ç»å¯¹å®šä½åœ¨ .phone å†…éƒ¨åº•éƒ¨');
  const ch = document.querySelectorAll('.choices .choice');
  if(ch.length && ch.length!==3) 
    return warn('âŒ é€‰é¡¹å¿…é¡» 3 ä¸ªï¼Œä¸”åªæ˜¾ç¤ºä¸€ç»„ï¼ˆ123ï¼‰');
  const myAcks = document.querySelectorAll('.msg.me .ack');
  if(myAcks.length>1) 
    return warn('âŒ å›æ‰§åªèƒ½å‡ºç°åœ¨"æˆ‘æ–¹æœ€åä¸€æ¡"æ°”æ³¡å†…');
})();
</script>

</body>
</html>
